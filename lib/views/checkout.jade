extends ./base.jade

append body
    if this.state.data
        .container
            h2 Warenausgang
                .btn-toolbar.pull-right
                    button.btn.btn-default(onClick=this.cancel)
                        i.glyphicon.glyphicon-chevron-left
                        |  Abbrechen
                    button.btn.btn-primary(onClick=this.finish)
                        i.glyphicon.glyphicon-ok
                        |  Abschliessen
            .row
                .col-xs-12
                    .form-horizontal
                        .form-group
                            label.col-lg-2.control-label Person
                            .col-lg-10
                                ContactBox(value=this.state.data.person onChange=this.onPersonChanged type="person" disabled=!this.state.data.draft)
            .row
                .col-xs-12.col-md-8
                    h3 Equipment
                    table.table.table-striped.table-hover
                        thead
                            tr
                                th ID
                                th Name
                                each supplier in this.state.suppliers
                                    th
                                        img(src="/api/contacts/"+supplier+"/image" style="height:20px")
                                th Total
                        tbody
                            each type in this.state.data.types
                                if type.needed !== undefined || type.count > 0
                                    tr(onClick=this.startScan(type._id) className=((this.state.data.types[type._id].needed&&this.state.data.types[type._id].needed>(this.state.data.types[type._id].count||0))?"danger":""))
                                        td= type._id
                                        td= type.name
                                        each supplier in this.state.suppliers
                                            td
                                                = ((this.state.data.types[type._id].suppliers && this.state.data.types[type._id].suppliers[supplier])?(this.state.data.types[type._id].suppliers[supplier].count||"0"):"0")
                                                | /
                                                = ((this.state.data.types[type._id].suppliers && this.state.data.types[type._id].suppliers[supplier])?this.state.data.types[type._id].suppliers[supplier].available:0)
                                        td
                                            = this.state.data.types[type._id].count||"0"
                                            if this.state.data.types[type._id].needed
                                                = "/"+this.state.data.types[type._id].needed
                .col-md-4
                    .pull-left
                        h3 Verlauf
                    if this.state.data.draft
                        .btn-toolbar.pull-right(style="marginTop:18px")
                            DropdownButton(title=this.renderSupplierButtonTitle(null,null,this.state.supplier||"own")[0] onSelect=this.setSupplier)        
                                each supplier in this.state.allsuppliers
                                    MenuItem(eventKey=supplier)
                                        img(src="/api/contacts/"+supplier+"/image" style="height:20px")
                            ScanButton.pull-left(onScan=this.handleScan supplier=this.state.supplier ref="scanbutton")
                            QuaggaButton.pull-left.visible-xs(onScan=this.onQuaggaScan)
                    table.table.table-striped.table-hover
                        thead
                            th
                            th Name
                            th
                        tbody
                            each entry,i in this.state.data.history.slice().reverse()
                                tr
                                    td
                                        img(src="/api/contacts/"+entry.supplier+"/image" style="height:20px")
                                    td
                                        +renderLogEntry(entry,0)
                                    td
                                        if this.state.data.draft
                                            .btn.btn-xs.btn-default(onClick=this.remove(i))
                                                .glyphicon.glyphicon-trash
mixin renderLogEntry(entry,level)
    if entry.items
        each contents,item in entry.items
            div(style="paddingLeft:"+(level*20)+"px")
                = this.state.data.types[entry.type].name
                b= " #"+item
            each subentry in contents
                +renderLogEntry(subentry,level+1)
    else
        div(style="paddingLeft:"+(level*20)+"px")
            b= entry.count+" "
            = this.state.data.types[entry.type].name
mixin renderSupplierButtonTitle(supplier)
    img(src="/api/contacts/"+supplier+"/image" style="height:20px")
script.
    var client = require("../client.js");
    var async = require("async");
    var ScanButton = require("./ScanButton.jade");
    var async = require("async");
    var DropdownButton = require("react-bootstrap/DropdownButton");
    var MenuItem = require("react-bootstrap/MenuItem");
    var QuaggaButton = require("./QuaggaButton.jade");
    var bs = require("../barcodescanner.js");
    var ContactBox = require("./ContactBox.jade");
    
    exports.getNeededPermissions = function(){
        return ["projects_read"];
    }
    
    exports.componentDidMount = function(){
        if(!this.state.data) this.loadData();
    }
    
    exports.loadData = function(){
        client.getCheckout(this.props.params.checkout,function(err,data){
            if(err) return;
            this.state.data = data;
            this.calculateSuppliers();
            var suppliers = {};
            for(var type in this.state.data.types){
                for(var supplier in this.state.data.types[type].suppliers) suppliers[supplier] = true;
            }
            this.state.allsuppliers = Object.keys(suppliers);
            this.state.supplier = "own";
            data.categories["undefined"] = {_id:"undefined",name:"Nicht kategorisiert"};
            for(var type in data.types){
                type = parseInt(type,10);
                var category = data.categories[data.types[type].category];
                if(!category.types) category.types = [];
                category.types.push(type);
            }

            this.update();
        }.bind(this));
    }
    
    exports.onPersonChanged = function(id){
        this.state.data.person = id;
        this.save();
    }
    
    exports.calculateSuppliers = function(){
        var suppliers = {};
        for(var type in this.state.data.types){
            if(this.state.data.types[type].count || this.state.data.types[type].needed)
            for(var supplier in this.state.data.types[type].suppliers) suppliers[supplier] = true;
        }
        this.state.suppliers = Object.keys(suppliers);
    }
    
    exports.setSupplier = function(supplier){
        this.state.supplier = supplier;
        this.update();
    }
    
    exports.startScan = function(type){
        return function(){
            this.refs.scanbutton.scan();
            this.refs.scanbutton.onEquipmenttypeChanged(type,[{value:type,label:this.state.data.types[type].name}]);
        }.bind(this)
    }
        
    exports.onQuaggaScan = function(code){
        bs.parse(code);
    }
    
    exports.handleScan = function(code){
        if(!this.state.data.draft) return;
        if(code.kind == "EQ" && this.state.data.types[code.type]){
            if(!code.supplier) code.supplier = this.state.supplier;
            var entry = {
                supplier:code.supplier||"own",
                type:code.type,
                count:code.count||1
            };
            
            if(code.item){                
                this.getEntryContents(entry,[code.item],function(err){
                    if(err) return this.playErrorSound();
                    this.add(entry);
                }.bind(this));
            }else if(entry.supplier == "own" && this.state.data.types[entry.type].hasItems){
                return this.playErrorSound();
            }else{
                this.add(entry);
            }           
        }
    }
    
    exports.getEntryContents = function(entry,items,cb){
        async.each(items,function(item,cb){
            client.getEquipment(entry.type,item,function(err,item){
                if(err) return cb(err);
                item = item.item;
                if(!entry.items) entry.items = {};
                async.map(Object.keys(item.contents),function(type,cb){
                    var subentry = {
                        supplier:entry.supplier,
                        type:type,
                        count:item.contents[type].count
                    };
                    if(item.contents[type].ids){
                        this.getEntryContents(subentry,item.contents[type].ids,function(err){
                            if(err) return cb(err);
                            cb(null,subentry);
                        }.bind(this));
                    }else{
                        cb(null,subentry);
                    }
                }.bind(this),function(err,items){
                    if(err) return cb(err);
                    entry.items[item.id] = items;
                    cb();
                }.bind(this))
            }.bind(this))
        }.bind(this),cb);
    }
    
    exports.calculateEntryTotal = function(entry,total){
        total = total||{};
        if(!total[entry.type]) total[entry.type] = {count:0};
        total[entry.type].count += entry.count;
        for(var item in entry.items){
            item = parseInt(item,10);
            if(!total[entry.type].ids) total[entry.type].ids = [];
            if(total[entry.type].ids.indexOf(item) < 0) total[entry.type].ids.push(item);
            for(var i = 0; i < entry.items[item].length; i++){
                this.calculateEntryTotal(entry.items[item][i],total);
            }
        }
        return total;
    }
    
    exports.checkAvailability = function(supplier,total){
        for(var type in total){
            if(
                !this.state.data.types[type].suppliers ||
                !this.state.data.types[type].suppliers[supplier] ||
                ((this.state.data.types[type].suppliers[supplier].available||0) - (this.state.data.types[type].suppliers[supplier].count||0)) < total[type].count
            ){
                return false;
            }
            if(total[type].ids){
                for(var i = 0; i < total[type].ids.length; i++){
                    if(
                        this.state.data.types[type].suppliers[supplier].ids &&
                        this.state.data.types[type].suppliers[supplier].ids.indexOf(total[type].ids[i]) >= 0
                    ){
                        return false;
                    }
                }
            }
        }
        return true;
    }
        
    exports.add = function(entry){
        var total = this.calculateEntryTotal(entry);
        if(this.checkAvailability(entry.supplier,total)){
            for(var type in total){
                if(!this.state.data.types[type].count) this.state.data.types[type].count = 0;
                this.state.data.types[type].count += total[type].count;
                if(!this.state.data.types[type].suppliers[entry.supplier]) this.state.data.types[type].suppliers[entry.supplier] = {count:0,available:0}
                if(!this.state.data.types[type].suppliers[entry.supplier].count) this.state.data.types[type].suppliers[entry.supplier].count = 0;
                this.state.data.types[type].suppliers[entry.supplier].count += total[type].count;
                if(total[type].ids) {
                    if(!this.state.data.types[type].suppliers[entry.supplier].ids) this.state.data.types[type].suppliers[entry.supplier].ids = [];
                    Array.prototype.splice.apply(this.state.data.types[type].suppliers[entry.supplier].ids,[0,0].concat(total[type].ids));
                }
            }
            this.state.data.history.push(entry);
            this.calculateSuppliers();
            this.update();
            this.save();
        }else{
            this.playErrorSound();
        }
    }
    
    exports.remove = function(index){
        return function(){
            var entry = this.state.data.history.splice(this.state.data.history.length-1-index,1)[0];
            var total = this.calculateEntryTotal(entry);
            for(var type in total){
                if(total[type].ids) {
                    for(var i = 0; i < total[type].ids.length; i++){
                        this.state.data.types[type].suppliers[entry.supplier].ids.splice(this.state.data.types[type].suppliers[entry.supplier].ids.indexOf(total[type].ids[i]),1);
                    }
                    if(!this.state.data.types[type].suppliers[entry.supplier].ids.length) delete this.state.data.types[type].suppliers[entry.supplier].ids;
                }
                this.state.data.types[type].suppliers[entry.supplier].count -= total[type].count;
                if(!this.state.data.types[type].suppliers[entry.supplier].count){
                    delete this.state.data.types[type].suppliers[entry.supplier].count;
                    if(!this.state.data.types[type].suppliers[entry.supplier].available && !this.state.data.types[type].suppliers[entry.supplier].needed) delete this.state.data.types[type].suppliers[entry.supplier];
                }
            
                this.state.data.types[type].count -= total[type].count;
                if(!this.state.data.types[type].count) delete this.state.data.types[type].count
            }
            this.calculateSuppliers();
            this.update();
            this.save();
        }.bind(this);
    }
    
    exports.playErrorSound = function(){
        new Audio("/public/audio/error.wav").play();
    }

    exports.cancel = function(){
        history.back();
    }

    exports.save = function(){
        var data = {};
        for(var type in this.state.data.types){
            var t = this.state.data.types[type];
            if(!t.count) continue;
            data[type] = {
                count:t.count,
                suppliers:{}
            };
            for(var supplier in t.suppliers){
                if(!t.suppliers[supplier].count) continue;
                data[type].suppliers[supplier] = {
                    count:t.suppliers[supplier].count,
                    ids:t.suppliers[supplier].ids
                };
            }
        }
    
        client.updateEquipmentIo(this.props.params.checkout,{person:this.state.data.person,items:data,history:this.state.data.history},function(err){
            if(err) return true;
        });
    }
    
    exports.finish = function(){
        client.finishEquipmentIo(this.props.params.checkout,function(err){
            if(err) return true;
            history.back();
        })
    }
