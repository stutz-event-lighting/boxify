extends ./base.jade

append body
    - this.checkData();
    .container
        h2
            | Benutzer
            button.btn.btn-primary.pull-right(onClick=this.create) Neu
        table.table.table-striped
            thead
                tr
                    th Name
                    th E-Mail
                    th Letze Aktivit√§t
            tbody
                each user in this.props.users
                    tr(onClick=this.edit(user))
                        td= user.firstname+" "+user.lastname
                        td= user.email
                        td
                            | 12.12.2014 12:34:12
                            button.btn.btn-default.btn-xs.pull-right(onClick=this.delete(user))
                                i.glyphicon.glyphicon-trash
    if this.props.create
        .modal(style="display:block").fade.in
            .modal-backdrop(style="bottom:0px;display:block").fade.in
            .modal-dialog
                .modal-content
                    .modal-header
                        h2 User anlegen
                    .modal-body
                        .form-horizontal
                            .form-group
                                label.col-lg-2.control-label Vor- und Nachname
                                .col-lg-10
                                    .row
                                        .col-xs-6
                                            input.form-control(type="text" value=this.props.create.firstname onChange=this.validateCreateFirstname.bind(this))
                                        .col-xs-6
                                            input.form-control(type="text" value=this.props.create.lastname onChange=this.validateCreateLastname.bind(this))
                            .form-group
                                label.col-lg-2.control-label E-Mail
                                .col-lg-10
                                    input.form-control(type="text" value=this.props.create.email onChange=this.validateCreateMail.bind(this))
                            .form-group
                                label.col-lg-2.control-label Passwort
                                .col-lg-10
                                    input.form-control(type="password" value=this.props.create.password onChange=this.validateCreatePassword.bind(this))
                    .modal-footer
                        button.btn.btn-default(onClick=this.cancelCreate) Abbrechen
                        button.btn.btn-primary(onClick=this.confirmCreate) Erstellen
script.
    var client = require("../client.js");
    
    exports.getNeededPermissions = function(){
        return ["users_read"];
    }
    
    exports.checkData = function(){
        var self = this;
        if(!this.props.users){
            client.getUsers(function(err,users){
                if(err) return;
                self.props.users = users;
                self.update();
            })
        }
    }
    
    exports.create = function(){
        this.props.create = {firstname:"",lastname:"",email:"",password:""};
        this.update();
    }
    
    exports.validateCreateFirstname = function(e){
        this.props.create.firstname = e.target.value;
        this.update();
    }
    
    exports.validateCreateLastname = function(e){
        this.props.create.lastname = e.target.value;
        this.update();
    }
    
    exports.validateCreateMail = function(e){
        this.props.create.email = e.target.value;
        this.update();
    }
    
    exports.validateCreatePassword = function(e){
        this.props.create.password = e.target.value;
        this.update();
    }
    
    exports.cancelCreate = function(){
        delete this.props.create;
        this.update();
    }
    
    exports.confirmCreate = function(){
        var self = this;
        client.createUser({
            firstname:this.props.create.firstname,
            lastname:this.props.create.lastname,
            email:this.props.create.email,
            password:this.props.create.password            
        },function(err,id){
            if(err) return;
            delete self.props.create;
            self.update();
            visit("/users/"+id);            
        });
    }
    
    exports.edit = function(user){    
        return function(e){
            if(e.target.tagName == "I" || e.target.tagName == "BUTTON") return;
            visit("/users/"+user._id)
        }        
    }
    
    exports.delete = function(user){
        var self = this;
        return function(){
            client.deleteUser(user._id,function(err){
                delete self.props.users;
                self.update();
            });
        }
    }
    
    
